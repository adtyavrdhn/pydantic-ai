from collections.abc import Sequence
from dataclasses import dataclass

from pydantic_ai import _instructions
from pydantic_ai.builtin_tools import AbstractBuiltinTool
from pydantic_ai.messages import ModelMessage, ModelResponse
from pydantic_ai.models import ModelRequestParameters
from pydantic_ai.settings import ModelSettings, merge_model_settings
from pydantic_ai.tools import AgentDepsT, BuiltinToolFunc, RunContext
from pydantic_ai.toolsets import AbstractToolset, CombinedToolset

from .abstract import AbstractCapability


@dataclass
class CombinedCapability(AbstractCapability[AgentDepsT]):
    capabilities: Sequence[AbstractCapability[AgentDepsT]]

    def get_instructions(self) -> _instructions.Instructions[AgentDepsT] | None:
        instructions = []
        for capability in self.capabilities:
            instructions.extend(_instructions.normalize_instructions(capability.get_instructions()))  # type: ignore[reportPrivateUsage]
        return instructions or None

    def get_model_settings(self) -> ModelSettings | None:
        model_settings = ModelSettings()
        for capability in self.capabilities:
            model_settings = merge_model_settings(model_settings, capability.get_model_settings())
        return model_settings or None

    def get_toolset(self) -> AbstractToolset[AgentDepsT] | None:
        toolsets = [toolset for capability in self.capabilities if (toolset := capability.get_toolset())]
        return CombinedToolset(toolsets) if toolsets else None

    def get_builtin_tools(self) -> Sequence[AbstractBuiltinTool | BuiltinToolFunc[AgentDepsT]]:
        builtin_tools: list[AbstractBuiltinTool | BuiltinToolFunc[AgentDepsT]] = []
        for capability in self.capabilities:
            builtin_tools.extend(capability.get_builtin_tools() or [])
        return builtin_tools

    async def before_model_request(
        self,
        ctx: RunContext[AgentDepsT],
        *,
        messages: list[ModelMessage],
        model_settings: ModelSettings,
        model_request_parameters: ModelRequestParameters,
    ) -> tuple[list[ModelMessage], ModelSettings, ModelRequestParameters]:
        for capability in self.capabilities:
            messages, model_settings, model_request_parameters = await capability.before_model_request(
                ctx, messages=messages, model_settings=model_settings, model_request_parameters=model_request_parameters
            )
        return messages, model_settings, model_request_parameters

    async def after_model_request(
        self,
        ctx: RunContext[AgentDepsT],
        *,
        response: ModelResponse,
    ) -> ModelResponse:
        for capability in reversed(self.capabilities):
            response = await capability.after_model_request(ctx, response=response)
        return response
